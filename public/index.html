<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="./assets/css/styles.css" rel="stylesheet">
  <script src="./assets/js/common/utils.js"></script>
  <script src="./assets/js/common/error.js"></script>
  <script src="./assets/js/common/constants.js"></script>
  <script src="./assets/js/common/ViewModel.js"></script>  
  <script src="./assets/js/features/rules/constants.js"></script>
  <script src="./assets/js/features/rules/rules.js"></script>
  <script src="./assets/js/features/rules/view.js"></script>
</head>

<body>
  <div id="message">
    <h2>Where are cycles allowed on London public transport</h2>

    <div id="date-picker-container">
      <input type="datetime-local" onchange="onDateSelected(this.value)" id="datetime_picker">
      <button class="button button1" onclick="onResetClicked()">reset</button>
    </div>

    <table id="rules">

    </table>
    <div>
      <div id="resource"><a target='_blank'
          href='https://tfl.gov.uk/cdn/static/cms/documents/cycles-on-public-transport.pdf'>Cycles on
          Public
          Transport map (PDF)</a></div>
      <div id="resource"><a target='_blank' href='disruptions.html'>Disruptions</a></div>
    </div>
  </div>
  <p id="footer">Source: <a
      href="https://tfl.gov.uk/modes/cycling/cycles-on-public-transport">https://tfl.gov.uk/modes/cycling/cycles-on-public-transport</a>
  </p>
  <p id="footer">Leave a feedback: <a href='mailto:droidique@gmail.com'>droidique@gmail.com</a></p>

  <script>
    let renderer = new RulesView()
    renderer.populateRules = renderRulesUIModel;
    renderer.showError = globalHandleUIError;
    let viewModel = new RulesViewModel(document, renderer);



    function onDateSelected(rawDateTime) {
      const dateTime = new Date(`${rawDateTime}`);
      viewModel.onNewDateTimeSelected(dateTime);
    }

    function onResetClicked() {
      viewModel.onResetClicked();
    }

    function renderRulesUIModel(rules) {
      var { dateTime, lineRules } = rules;
      const dateControl = document.querySelector('#datetime_picker');
      dateControl.value = dateTime;
      const tableElement = document.querySelector('#rules');
      tableElement.innerHTML = "";
      lineRules.forEach(ruleEntry => {
        var row = tableElement.insertRow(tableElement.rows.length);
        adaptRuleRow(row, ruleEntry.line, ruleEntry.targetRule, ruleEntry.targetTimeOfDay);
      });
    }

    function adaptRuleRow(row, line, targetRule, targetTimeOfDay) {
      var cellLine = row.insertCell(0);
      cellLine.innerHTML = RuleEntryInfo.get(line).name;
      cellLine.style.color = RuleEntryInfo.get(line).textColor;
      cellLine.style.backgroundColor = RuleEntryInfo.get(line).backgroundColor;

      var cellRule = row.insertCell(1);
      cellRule.style.borderRightColor = targetRule.statusColor;
      cellRule.style.borderRightWidth = "5px";
      var message = `${targetRule.message.replaceAll("\n", "<br />")}`;
      if (targetRule.showHours) {
        message += `<br/>(${targetTimeOfDay})`;
      }
      cellRule.innerHTML = message;
    }
  </script>
</body>

</html>