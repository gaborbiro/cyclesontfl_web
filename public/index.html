<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="./assets/css/styles.css" rel="stylesheet">
  <script src="./assets/js/utils.js"></script>
  <script src="./assets/js/rules.js"></script>
  </script>
</head>

<body>
  <div id="message">
    <h2>Where are cycles allowed on London public transport</h2>

    <div id="date-picker-container">
      <input type="datetime-local" onchange="onDateSelected(this.value)" id="datetime_picker">
    </div>

    <table id="rules">

    </table>
  </div>
  <p id="footer">Source: <a
      href="https://tfl.gov.uk/modes/cycling/cycles-on-public-transport">https://tfl.gov.uk/modes/cycling/cycles-on-public-transport</a>
  </p>
  <p id="footer">Leave a feedback: <a href='mailto:droidique@gmail.com'>droidique@gmail.com</a></p>

  <script>
    const dateControl = document.querySelector('#datetime_picker');

    document.addEventListener('DOMContentLoaded', function () {
      const now = new Date();

      dateControl.value = getBST_Input_Date(now);

      const lineRules = getLineRules(now);

      populateRules(lineRules);
    });

    function onDateSelected(rawDateTime) {
      const dateTime = new Date(`${rawDateTime}`);
      populateRules(getLineRules(dateTime));
    }

    /**
     * Translates the specified date-time into the British Summer Time and formats it as following:
     * YYYY-MM-DD'T'HH:mm
     * This can be used to set the value of the datetime-local html input field.
     */
    function getBST_Input_Date(dateTime) {
      const bstTimezone = 'Europe/London'
      // Cheating with the Canadian format a bit, as it produces the ISO date-format, allowing it to be used with the date picker
      const simpleFormattedDate = dateTime.toLocaleDateString('en-CA', { timeZone: bstTimezone });
      const simpleFormattedTime = dateTime.toLocaleTimeString('en-GB', { timeZone: bstTimezone });
      return `${simpleFormattedDate}T${simpleFormattedTime}`.substring(0, 16);
    }

    function populateRules(lineRules) {
      const tableElement = document.querySelector('#rules');
      tableElement.innerHTML = "";
      lineRules.forEach((lineRule, line) => {
        const { previousTimeOfDay, previousRule, targetTimeOfDay, targetRule, nextTimeOfDay, nextRule } = lineRule;
        var row = tableElement.insertRow(tableElement.rows.length);
        var cellLine = row.insertCell(0);
        cellLine.innerHTML = line;
        cellLine.style.color = lineColors.get(line).textColor;
        cellLine.style.backgroundColor = lineColors.get(line).backgroundColor;
        var cellRule = row.insertCell(1);

        var rule;
        if (targetRule.showHours) {
          rule = `${targetRule.message.replaceAll("\n", "<br />")} (${targetTimeOfDay})`;
        } else {
          rule = `${targetRule.message.replaceAll("\n", "<br />")}`;
        }
        // if (previousRule != targetRule || nextRule != targetRule) {
        //   rule += "<p id='rule-small'>"
        //   if (previousRule != targetRule) {
        //     rule += `<br />${previousRule.replaceAll("\n", "<br />")} (${previousTimeOfDay})`;
        //   }
        //   if (nextRule != targetRule) {
        //     rule += `<br />${nextRule.replaceAll("\n", "<br />")} (${nextTimeOfDay})`
        //   } 
        //   rule += "</p>"
        // }
        cellRule.innerHTML = rule;
      });
    }
  </script>
</body>

</html>